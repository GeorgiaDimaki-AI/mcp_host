# MCP Webview Developer Guide

## Complete Guide to Creating MCP Servers with Webview Elicitation

This guide shows you how to create MCP servers that use webviews to collect data and present results **without involving the LLM**. This is ideal for handling sensitive data, creating wizards, or building interactive tools.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Key Concepts](#key-concepts)
3. [Getting Started](#getting-started)
4. [Creating Your First MCP Webview Tool](#creating-your-first-mcp-webview-tool)
5. [Form Elicitation Patterns](#form-elicitation-patterns)
6. [Result Presentation Patterns](#result-presentation-patterns)
7. [Advanced Techniques](#advanced-techniques)
8. [Best Practices](#best-practices)
9. [Security Considerations](#security-considerations)
10. [Troubleshooting](#troubleshooting)

---

## Architecture Overview

### Data Flow

```
User clicks MCP tool in UI
        ↓
MCP Server returns webview HTML
        ↓
Webview displayed in modal overlay (NOT in chat)
        ↓
User interacts with webview
        ↓
Data sent directly to MCP server
        ↓
MCP server processes data (LLM never sees it)
        ↓
Optionally return another webview or confirmation
```

### Key Difference from Chat Webviews

| Aspect | Chat Webviews | MCP Webviews |
|--------|--------------|--------------|
| **Source** | Generated by LLM | Generated by MCP server |
| **Display** | Inline in chat | Modal overlay |
| **History** | Saved in chat | NOT saved in chat |
| **Data flow** | Goes through LLM | Direct to MCP server |
| **Use case** | General interaction | Sensitive data, wizards |

---

## Key Concepts

### 1. Webview Syntax

MCP servers return webviews using a special markdown code block:

````markdown
```webview:type
<html content>
```
````

**Types:**
- `form` - Interactive forms for data collection
- `result` - Data visualization and results
- `html` - General interactive content

### 2. Message Passing

Webviews communicate with the MCP server using `window.sendToHost()`:

```javascript
window.sendToHost({
  type: 'form-submit',
  formData: { /* your data */ }
});
```

### 3. Privacy Guarantee

**Important:** MCP webview data does NOT go through the LLM. This makes it perfect for:
- Collecting credentials
- Personal information
- API keys
- Database configurations
- Any sensitive data

---

## Getting Started

### Prerequisites

```bash
npm install @modelcontextprotocol/sdk
```

### Basic MCP Server Template

```javascript
import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';

const server = new Server(
  { name: 'my-server', version: '1.0.0' },
  { capabilities: { tools: {} } }
);

// List tools
server.setRequestHandler('tools/list', async () => {
  return {
    tools: [
      {
        name: 'my_tool',
        description: 'My webview tool',
        inputSchema: {
          type: 'object',
          properties: {},
        },
      },
    ],
  };
});

// Handle tool calls
server.setRequestHandler('tools/call', async (request) => {
  if (request.params.name === 'my_tool') {
    return {
      content: [{
        type: 'text',
        text: \`Your description here

\\\`\\\`\\\`webview:form
<html content>
\\\`\\\`\\\`\`,
      }],
    };
  }
});

// Start server
const transport = new StdioServerTransport();
server.connect(transport);
```

### Configuration

Add to `backend/mcp-config.json`:

```json
{
  "mcpServers": {
    "my-server": {
      "command": "node",
      "args": ["path/to/your/server.js"]
    }
  }
}
```

---

## Creating Your First MCP Webview Tool

### Example: Simple Data Collection Form

```javascript
function handleDataCollection() {
  return {
    content: [{
      type: 'text',
      text: \`Please provide your information:

\\\`\\\`\\\`webview:form
<div style="padding: 20px; max-width: 500px;">
  <h2>User Information</h2>

  <form id="userForm">
    <label>Name:</label>
    <input type="text" name="name" required />

    <label>Email:</label>
    <input type="email" name="email" required />

    <button type="submit">Submit</button>
  </form>
</div>

<script>
document.getElementById('userForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const formData = {
    name: e.target.name.value,
    email: e.target.email.value,
    timestamp: new Date().toISOString(),
  };

  // Send to MCP server (bypasses LLM)
  window.sendToHost({ type: 'form-submit', formData });
});
</script>
\\\`\\\`\\\`\`,
    }],
  };
}
```

---

## Form Elicitation Patterns

### Pattern 1: Simple Input Form

```html
<form id="myForm">
  <label>Field Label:</label>
  <input type="text" name="fieldName" required />
  <button type="submit">Submit</button>
</form>

<script>
document.getElementById('myForm').addEventListener('submit', function(e) {
  e.preventDefault();
  window.sendToHost({
    type: 'form-submit',
    formData: {
      fieldName: e.target.fieldName.value
    }
  });
});
</script>
```

### Pattern 2: Multi-Step Form

```javascript
let step = 1;
const formData = {};

function nextStep() {
  if (step === 1) {
    formData.name = document.getElementById('name').value;
    // Show step 2
  } else if (step === 2) {
    formData.email = document.getElementById('email').value;
    // Submit all data
    window.sendToHost({ type: 'form-submit', formData });
  }
  step++;
}
```

### Pattern 3: Dynamic Form Fields

```javascript
function addField() {
  const container = document.getElementById('fieldsContainer');
  const field = document.createElement('input');
  field.type = 'text';
  field.name = 'field_' + Date.now();
  container.appendChild(field);
}
```

### Pattern 4: File Upload Simulation

```javascript
<input type="file" id="fileInput" accept=".json,.csv" />

<script>
document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const reader = new FileReader();

  reader.onload = function(event) {
    window.sendToHost({
      type: 'file-upload',
      fileName: file.name,
      content: event.target.result
    });
  };

  reader.readAsText(file);
});
</script>
```

---

## Result Presentation Patterns

### Pattern 1: Data Table

```html
<table style="width: 100%; border-collapse: collapse;">
  <thead>
    <tr style="background: #f3f4f6;">
      <th>Column 1</th>
      <th>Column 2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Data 1</td>
      <td>Data 2</td>
    </tr>
  </tbody>
</table>
```

### Pattern 2: Metric Cards

```html
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
  <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 20px; border-radius: 8px; color: white;">
    <div style="font-size: 14px;">Metric Name</div>
    <div style="font-size: 32px; font-weight: bold;">123</div>
  </div>
</div>
```

### Pattern 3: Progress Indicator

```html
<div style="background: #e5e7eb; border-radius: 9999px; height: 8px;">
  <div style="background: #3b82f6; height: 100%; width: 75%; border-radius: 9999px;"></div>
</div>
<div style="text-align: center; margin-top: 8px;">75% Complete</div>
```

### Pattern 4: Status Messages

```html
<div style="padding: 12px; background: #d1fae5; border-left: 3px solid #10b981; border-radius: 4px;">
  <strong>Success!</strong> Your operation completed successfully.
</div>
```

---

## Advanced Techniques

### 1. Maintaining State Between Interactions

```javascript
// In your MCP server
const sessionData = new Map();

function storeData(sessionId, data) {
  sessionData.set(sessionId, data);
}

function getData(sessionId) {
  return sessionData.get(sessionId);
}
```

### 2. Chaining Multiple Webviews

```javascript
// First webview collects data
// On submit, call another MCP tool that shows next webview
function handleStep1Submit(data) {
  storage.step1 = data;
  return showStep2Webview();
}
```

### 3. Real-time Validation

```html
<input type="email" id="email" />
<div id="emailError" style="color: red; display: none;">Invalid email</div>

<script>
document.getElementById('email').addEventListener('blur', function(e) {
  const email = e.target.value;
  const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

  document.getElementById('emailError').style.display =
    isValid ? 'none' : 'block';
});
</script>
```

### 4. Interactive Preview

```html
<textarea id="jsonInput"></textarea>
<pre id="preview" style="background: #f3f4f6; padding: 12px;"></pre>

<script>
document.getElementById('jsonInput').addEventListener('input', function(e) {
  try {
    const parsed = JSON.parse(e.target.value);
    document.getElementById('preview').textContent =
      JSON.stringify(parsed, null, 2);
  } catch (err) {
    document.getElementById('preview').textContent = 'Invalid JSON';
  }
});
</script>
```

---

## Best Practices

### 1. Always Provide Context

```html
<div style="background: #eff6ff; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
  <strong>Note:</strong> This data is collected securely and will not be shared with the LLM.
</div>
```

### 2. Use Clear Labels and Help Text

```html
<label>
  Email Address
  <span style="color: #6b7280; font-size: 14px;">(We'll never share this)</span>
</label>
<input type="email" name="email" />
```

### 3. Validate Before Submission

```javascript
document.getElementById('form').addEventListener('submit', function(e) {
  e.preventDefault();

  // Validate
  const email = e.target.email.value;
  if (!email || !email.includes('@')) {
    alert('Please enter a valid email');
    return;
  }

  // Submit
  window.sendToHost({ type: 'form-submit', formData: { email } });
});
```

### 4. Provide Feedback

```javascript
// Show loading state
const button = e.target.querySelector('button');
button.textContent = 'Submitting...';
button.disabled = true;

window.sendToHost({ type: 'form-submit', formData });
```

### 5. Handle Errors Gracefully

```javascript
try {
  const data = processData();
  window.sendToHost({ type: 'form-submit', formData: data });
} catch (error) {
  alert('Error: ' + error.message);
}
```

---

## Security Considerations

### 1. Data Privacy

✅ **DO:**
- Use MCP webviews for sensitive data
- Validate all inputs server-side
- Sanitize user input
- Use HTTPS in production

❌ **DON'T:**
- Send credentials through chat webviews
- Trust client-side validation alone
- Store sensitive data in localStorage
- Include API keys in HTML

### 2. Input Validation

```javascript
// Server-side validation
function validateEmail(email) {
  const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return regex.test(email);
}

// Sanitize input
function sanitize(input) {
  return input.replace(/[<>]/g, '');
}
```

### 3. XSS Prevention

```javascript
// Always escape user input when displaying
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
```

---

## Troubleshooting

### Webview Not Displaying

**Problem:** Webview doesn't appear after calling MCP tool

**Solutions:**
1. Check that the response includes the webview syntax
2. Verify the webview type is `form`, `result`, or `html`
3. Check browser console for errors
4. Ensure HTML is properly escaped in the response

### Form Data Not Reaching Server

**Problem:** Form submission doesn't trigger response

**Solutions:**
1. Verify `window.sendToHost()` is called
2. Check that event.preventDefault() is present
3. Ensure form has correct event listener
4. Check that data structure is correct

### HTML Rendering Issues

**Problem:** HTML doesn't render correctly

**Solutions:**
1. Use inline styles (external CSS not supported)
2. Escape special characters in HTML
3. Test HTML in isolation first
4. Check for JavaScript errors

### MCP Server Not Connecting

**Problem:** MCP tools don't appear in UI

**Solutions:**
1. Check `mcp-config.json` syntax
2. Verify server command and args
3. Check server logs for errors
4. Ensure server implements required handlers

---

## Complete Working Example

See `examples/mcp-webview-example.js` for a complete, working MCP server with:
- User registration form
- Feedback collection
- Data summary visualization
- Interactive query builder

To run:

```bash
# 1. Ensure dependencies are installed
cd backend
npm install

# 2. Add to backend/mcp-config.json:
{
  "mcpServers": {
    "example": {
      "command": "node",
      "args": ["examples/mcp-webview-example.js"]
    }
  }
}

# 3. Restart backend
npm run dev

# 4. Click "MCP Tools" in UI
```

---

## Additional Resources

- [MCP SDK Documentation](https://github.com/modelcontextprotocol/sdk)
- [Webview Guide](./WEBVIEW_GUIDE.md)
- [MCP Integration Guide](./MCP_GUIDE.md)
- [Example Server](../examples/mcp-webview-example.js)
- [Phase 3: Direct Backend Communication Guide](./Phase_3_Direct_Backend_Communication_Guide.md) - **New! Secure sensitive data submission**

---

## Summary

MCP webviews provide a powerful way to:
- Collect sensitive data securely
- Create multi-step wizards
- Build interactive tools
- Present results beautifully
- **All without involving the LLM**

The key advantages:
1. **Privacy:** Data never touches the LLM
2. **Control:** Full control over UI and UX
3. **Flexibility:** Use any HTML/CSS/JS
4. **Security:** Sandboxed execution

Start with simple forms, then build more complex workflows as needed!
